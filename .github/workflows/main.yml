name: CI MLflow

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python 3.11.2
        uses: actions/setup-python@v4
        with:
          python-version: '3.11.2'

      - name: Install dependencies
        working-directory: ./MLProject
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Unset MLFLOW_TRACKING_URI
        run: |
          unset MLFLOW_TRACKING_URI

      - name: Clean old mlruns
        run: |
          rm -rf mlruns
          rm -rf MLProject/mlruns

      - name: Run mlflow project
        working-directory: ./MLProject
        run: |
          mlflow run . --env-manager=local

      - name: Get latest MLflow run_id
        working-directory: ./MLProject
        id: get_run_id
        run: |
          RUN_ID=$(ls -td mlruns/0/*/ | head -n 1 | cut -d'/' -f3)
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT

      - name: Upload to GitHub Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mlflow-model
          path: mlruns/0/${{ steps.get_run_id.outputs.run_id }}/artifacts/model/

      - name: Upload to Google Drive
        working-directory: ./MLProject
        env:
          GDRIVE_CREDENTIALS: ${{ secrets.GDRIVE_CREDENTIALS }}
          GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
        if: success()
        run: |
          pip install --upgrade google-auth google-auth-oauthlib google-auth-httplib2 google-api-python-client
          python upload_to_gdrive.py

      - name: Build Docker Model
        working-directory: ./MLProject
        run: |
          run_id=${{ steps.get_run_id.outputs.run_id }}
          mlflow models build-docker -m mlruns/0/${{ steps.get_run_id.outputs.run_id }/artifacts/model -n ${{ secrets.DOCKER_USERNAME }}/mlflow-model

      - name: Log in to Docker Hub
        run: |
          echo "${{ secrets.DOCKER_PAT }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      - name: Tag Docker Image
        run: |
          docker tag ${{ secrets.DOCKER_USERNAME }}/mlflow-model ${{ secrets.DOCKER_USERNAME }}/mlflow-model:latest
          docker tag ${{ secrets.DOCKER_USERNAME }}/mlflow-model ${{ secrets.DOCKER_USERNAME }}/mlflow-model:${{ steps.get_run_id.outputs.run_id }}

      - name: Push Docker Image
        run: |
          docker push ${{ secrets.DOCKER_USERNAME }}/mlflow-model:latest
          docker push ${{ secrets.DOCKER_USERNAME }}/mlflow-model:${{ steps.get_run_id.outputs.run_id }}
